# 作業ログ: 2025-12-01

## 作業概要
Firebase Authentication設定時の「API key not valid」エラーのトラブルシューティング

---

## 発生した問題と解決プロセス

### 問題1: 複数の開発サーバーが同時起動 ✅ 解決済み

**症状:**
- 5つのNode.jsプロセスがポート5173～5177で同時に動作
- サーバー再起動のたびに古いプロセスが残り続ける

**原因:**
- 開発サーバーを再起動する際、前回のプロセスが正常に終了していなかった

**解決方法:**
1. タスクマネージャーを開く（Ctrl + Shift + Esc）
2. 「詳細」タブで全ての `node.exe` プロセスを検索
3. 全てのプロセスを「タスクの終了」で停止
4. 開発サーバーを再起動

**結果:** プロセスの重複は解消されたが、API keyエラーは継続

---

### 問題2: 間違ったAPIキーを使用 ✅ 解決済み

**症状:**
- `auth/api-key-not-valid` エラーが発生
- Firebase Authenticationが機能しない

**原因:**
- `.env` ファイルに設定していたAPIキーが間違っていた
- Google Cloud Consoleで新規作成したAPIキー (`AIzaSyByTZxcbHO27I7K6CIOMHQYJBbiDjXBUrs`) を使用していたが、Firebase Consoleに表示される正式なAPIキーとは異なっていた

**正しいAPIキー:**
```
AIzaSyCDFSS6o8zCFKDnpsJG6l5f_1CoXo1RNGk
```

**解決方法:**
1. Firebase Console → プロジェクト設定 → 全般タブ → マイアプリ
2. SDK設定に表示されているAPIキーを確認
3. `.env` ファイルを正しいAPIキーに更新:
```env
VITE_FIREBASE_API_KEY=AIzaSyCDFSS6o8zCFKDnpsJG6l5f_1CoXo1RNGk
```
4. Viteキャッシュをクリア: `rm -rf node_modules/.vite`
5. 開発サーバーを再起動

**結果:** APIキーは正しく設定されたが、エラーは継続

**ファイル:** [.env](../../techgear-store/.env)

---

### 問題3: Identity Platformへのアップグレードが必要 ✅ 解決済み

**症状:**
- Firebase Consoleに「Identity Platform にアップグレード」の警告が表示
- API key validation エラーが継続

**原因:**
- 古いFirebase Authentication APIを使用しており、Identity Platform機能が有効になっていなかった
- 新しいFirebase SDKとの互換性問題

**解決方法:**
1. Firebase Console → Authentication → ログイン方法タブ
2. 青い警告バナー「アップグレードして有効にする」をクリック
3. アップグレードウィザードに従って「次へ」をクリック
4. アップグレードを完了

**確認:**
- Firebase Consoleで「with Identity Platform」と表示されることを確認
- https://console.cloud.google.com/apis/library/identitytoolkit.googleapis.com?project=techgear-store-6f4e9 で「APIが有効です」と表示されることを確認

**結果:** Identity Platformへのアップグレード完了、しかしエラーは継続

---

### 問題4: API key validation エラーが継続 ❌ 未解決

**症状:**
- 正しいAPIキーを設定
- Identity Platformにアップグレード済み
- それでも `auth/api-key-not-valid` エラーが継続

**確認済み事項:**
- ✅ APIキーは正しい (`AIzaSyCDFSS6o8zCFKDnpsJG6l5f_1CoXo1RNGk`)
- ✅ `.env` ファイルに正しく設定されている
- ✅ Identity Toolkit API は有効
- ✅ Identity Platform にアップグレード済み
- ✅ Firebase Consoleで「メール/パスワード」と「Google」が有効
- ✅ Google Cloud ConsoleでAPIキーの制限は「なし」（unrestricted）
- ✅ アプリケーションの制限: なし
- ✅ APIの制限: キーを制限しない
- ✅ 開発サーバーを複数回再起動
- ✅ Viteキャッシュをクリア済み (`rm -rf node_modules/.vite`)
- ✅ ネットワークタブで正しいAPIキーがリクエストに含まれていることを確認

**ネットワークタブで確認した内容:**
- リクエストURL: `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyCDFSS6o8zCFKDnpsJG6l5f_1CoXo1RNGk`
- レスポンス: `400 Bad Request`
- エラーメッセージ: `API key not valid. Please pass a valid API key.`

**重要な発見:**
- ブラウザのJavaScriptは正しいAPIキーを使用してリクエストを送信している
- Google/Firebaseのサーバー側が「APIキーが無効」と拒否している
- つまり、**クライアント側の問題ではなく、サーバー側またはAPIキー自体の問題**

---

## トラブルシューティングで試した方法

### 1. API キーの制限設定を変更
- Google Cloud Console → APIとサービス → 認証情報
- 「Browser key (auto created by Firebase)」を選択
- 「アプリケーションの制限」: なし
- 「APIの制限」: キーを制限しない
- 結果: エラー継続

### 2. 新しいAPIキーを作成
- Google Cloud Consoleで新規APIキーを作成
- 無制限の設定で作成
- `.env` に設定
- 結果: Firebase Consoleの公式キーを使うべきだと判明

### 3. キャッシュのクリア
- Viteキャッシュ: `rm -rf node_modules/.vite`
- ブラウザキャッシュ: Ctrl + Shift + R（ハードリフレッシュ）
- 全てのブラウザタブを閉じる
- 結果: エラー継続

### 4. OAuth同意画面の確認
- Google Cloud Console → OAuth同意画面
- 設定が存在することを確認
- 結果: 設定は存在するが、詳細情報は不足

### 5. Firebase設定の再確認
- Firebase Console → プロジェクト設定
- SDK設定のAPIキーが `.env` と一致することを確認
- 結果: 完全一致、しかしエラー継続

---

## キャッシュが原因ではない理由

**ブラウザキャッシュの可能性: 低い（10%以下）**

根拠:
1. **ネットワークタブで確認済み**
   - リクエストURLに正しいAPIキー (`JG6l5f_1CoXo1RNGk`) が含まれている
   - キャッシュが原因なら古いキーが表示されるはず

2. **サーバー側のエラー**
   - エラーは `400 Bad Request` で、Firebase/Google側のサーバーが拒否している
   - クライアント側ではなく、サーバー側の問題

3. **複数回の再起動とキャッシュクリア**
   - 開発サーバーを5回以上再起動
   - Viteキャッシュもクリア済み
   - ブラウザのハードリフレッシュも実施

**反映の遅さの可能性: 低い（10%以下）**

根拠:
1. **Identity Platform アップグレード**
   - これは即座に反映される設定
   - アップグレード後すぐに「with Identity Platform」と表示

2. **APIキーの変更**
   - 最初の変更から30分以上経過
   - Google Cloudの設定反映は通常5-10分、最大30分

3. **時間経過**
   - トラブルシューティングは数時間にわたって実施
   - 十分な反映時間が経過している

---

## 現在の推測される原因

### 可能性A: APIキー自体に問題がある（確率: 40%）
- このAPIキーが何らかの理由で内部的に無効化されている
- APIキーに必要な権限が不足している
- Firebase ConsoleとGoogle Cloud Consoleの同期に問題がある

### 可能性B: Firebase/Google Cloudの設定に矛盾（確率: 30%）
- Identity Platform へのアップグレードが完全に完了していない
- Firebase ConsoleとGoogle Cloud Consoleの間で設定の不一致がある
- 内部的なプロジェクト設定エラー

### 可能性C: Firebase SDK v12の互換性問題（確率: 20%）
- 現在使用中: Firebase v12.6.0（2024年12月リリース）
- 新しすぎてバグが残っている可能性
- Identity Platformとの互換性問題

### 可能性D: OAuth同意画面の設定不足（確率: 10%）
- OAuth同意画面の詳細設定が不完全
- Google認証に必要な権限が不足

---

## 推奨される次のステップ

### ステップ1: APIキーを再生成する（最優先）

**理由:** 現在のAPIキー自体に問題がある可能性が高い

**手順:**
1. Google Cloud Console → APIとサービス → 認証情報
2. 新しいAPIキーを作成
   - 名前: `Firebase Web API Key - Manual`
   - アプリケーションの制限: なし
   - APIの制限: キーを制限しない
3. `.env` ファイルを新しいキーに更新
4. Viteキャッシュをクリア: `rm -rf node_modules/.vite`
5. 全てのnode.exeプロセスを停止
6. 開発サーバーを再起動
7. ブラウザのキャッシュをクリア（Ctrl + Shift + Delete）
8. テスト

### ステップ2: Firebase SDKをダウングレードする

**理由:** Firebase v12が新しすぎて未知のバグがある可能性

**手順:**
```bash
cd techgear-store
npm install firebase@11.0.2
rm -rf node_modules/.vite
npm run dev
```

### ステップ3: エラーの詳細を確認する

**手順:**
1. ブラウザのコンソールを開く
2. エラーの詳細（スタックトレース全体）をコピー
3. Firebase/Googleのドキュメントで該当エラーを検索
4. 同様の問題を抱えた他の開発者の解決策を調査

### ステップ4: OAuth同意画面を完全に設定する

**手順:**
1. Google Cloud Console → OAuth同意画面
2. アプリ情報を完全に入力
3. スコープを追加（必要な権限を設定）
4. テストユーザーを追加
5. 公開ステータスを確認

### ステップ5: 新しいFirebaseプロジェクトを作成（最終手段）

**理由:** 現在のプロジェクトに内部的な問題がある可能性

**手順:**
1. Firebase Consoleで新しいプロジェクトを作成
2. 最初からIdentity Platformを有効にする
3. 認証方法を設定
4. 新しい設定で `.env` を更新
5. テスト

---

## 使用した技術とツール

- **Firebase Authentication**: ユーザー認証システム
- **Identity Platform**: Googleの包括的な顧客IDソリューション
- **Google Cloud Console**: APIとサービスの管理
- **Vite**: 開発サーバー
- **React**: フロントエンドフレームワーク
- **Firebase SDK**: v12.6.0

---

## 関連ファイル

- [.env](../../techgear-store/.env) - Firebase設定
- [firebase.ts](../../techgear-store/src/lib/firebase.ts) - Firebase初期化
- [AuthContext.tsx](../../techgear-store/src/contexts/AuthContext.tsx) - 認証コンテキスト
- [package.json](../../techgear-store/package.json) - 依存関係

---

## 関連リンク

- Firebase Console: https://console.firebase.google.com/project/techgear-store-6f4e9
- Google Cloud Console: https://console.cloud.google.com/apis/credentials?project=techgear-store-6f4e9
- Identity Toolkit API: https://console.cloud.google.com/apis/library/identitytoolkit.googleapis.com?project=techgear-store-6f4e9

---

## まとめ

今回のトラブルシューティングで解決した問題:
1. ✅ 複数の開発サーバーの同時起動
2. ✅ 間違ったAPIキーの使用
3. ✅ Identity Platformへのアップグレード

未解決の問題:
1. ❌ `auth/api-key-not-valid` エラーの継続

**結論:**
- 正しいAPIキーを設定し、必要な設定を全て完了したにもかかわらず、エラーが継続
- ネットワークタブの分析から、クライアント側ではなく**サーバー側の問題**であることが判明
- APIキー自体、Firebase/Google Cloudの設定、またはSDKバージョンに問題がある可能性が高い
- 次のステップとして、APIキーの再生成、SDKのダウングレード、または新規プロジェクトの作成を推奨

**所要時間:** 約3-4時間

**学んだこと:**
- Firebase Consoleに表示されるAPIキーとGoogle Cloud Consoleで作成したAPIキーは異なる
- Identity Platformへのアップグレードが必要な場合がある
- ブラウザキャッシュだけでなく、Viteのビルドキャッシュもクリアする必要がある
- ネットワークタブでの詳細な分析が問題の切り分けに有効
