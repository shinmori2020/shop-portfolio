# Work Logs - Firebase Authentication問題の解決記録

## 2025-12-02: Firebase Authentication エラーの根本原因と解決

### 問題の経緯

複数日にわたり、Firebase Authenticationで `auth/api-key-not-valid` エラーが発生し続けていた問題が、本日ようやく解決しました。

### 実施した対応の履歴

#### フェーズ1: 旧プロジェクトでのトラブルシューティング（前セッション）

**プロジェクト:** `techgear-store-6f4e9`

1. **エラー内容**
   - `FirebaseError: Firebase: Error (auth/api-key-not-valid, please-pass-a-valid-api-key.)`
   - Email/Password認証、Google認証の両方で発生

2. **試した対策（すべて失敗）**
   - API keyの再作成
   - Firebase SDKのダウングレード（v12.6.0 → v11.0.2）
   - 24時間待機（Google Cloudの伝播を待つ）
   - ブラウザキャッシュのクリア
   - サーバーの再起動

3. **結論**
   - コード自体には問題がないことを確認
   - Firebaseプロジェクト自体に何らかの問題があると判断
   - 新規プロジェクトの作成を決定

#### フェーズ2: 新規Firebaseプロジェクトの作成（前セッション）

**新プロジェクト:** `techgear-store-v2`

1. **プロジェクト作成手順**
   - Firebase Consoleで新規プロジェクト `techgear-store-v2` を作成
   - Spark Plan（無料プラン）で設定
   - **重要:** Identity Platformを最初から有効化（旧プロジェクトは後から有効化していた）

2. **認証設定**
   - Email/Password認証を有効化
   - Google認証を有効化
   - Webアプリ "TechGear Store Web" を登録

3. **設定情報の取得**
   ```
   Project ID: techgear-store-v2
   API Key: AIzaSyBroPFWQozcVEMEbTTTh-1fZcS2FX4td04
   Auth Domain: techgear-store-v2.firebaseapp.com
   Storage Bucket: techgear-store-v2.firebasestorage.app
   Messaging Sender ID: 402915787528
   App ID: 1:402915787528:web:304f8fcfed19203a9ae2bd
   ```

4. **`.env`ファイルの更新**
   - 新しいFirebase設定情報で更新
   - **ここで重大なミスが発生（後述）**

#### フェーズ3: 新プロジェクトでのテスト（本セッション）

1. **開発環境の再起動**
   ```bash
   # Node.jsプロセスの停止
   taskkill /F /IM node.exe

   # Viteキャッシュのクリア
   rm -rf node_modules/.vite

   # サーバー再起動
   cd techgear-store
   npm run dev
   ```
   - サーバーは `http://localhost:5175/` で起動

2. **認証テスト実行**
   - シークレットモードでアクセス（ブラウザキャッシュを排除）
   - テストユーザーで新規登録を実行
   - **結果:** 同じ `auth/api-key-not-valid` エラーが発生

3. **追加調査**
   - ブラウザキャッシュをクリアしても解決せず
   - 新規プロジェクトでも同じエラー
   - Google Cloud ConsoleでのAPI key制限確認を提案

### 根本原因の発見

#### 発見の経緯

ユーザーから「画像だけでキーの情報を渡したのが間違いでした」との指摘を受け、Firebase Consoleのスクリーンショットと`.env`ファイルのAPI keyを文字単位で比較した。

#### 発見した問題

**`.env`ファイルに記録されたAPI key（誤）:**
```
AIzaSyBroPFMQozcVEMEbITTh-1fZcS2FX4td04
         ^^          ^^
```

**Firebase Consoleの実際のAPI key（正）:**
```
AIzaSyBroPFWQozcVEMEbTTTh-1fZcS2FX4td04
         ^^          ^^^
```

**タイプミスの箇所（2箇所）:**
1. 12-13文字目: `FM` → 正しくは `FW`
2. 20-22文字目: `bITT` → 正しくは `bTTT`

#### タイプミスが発生した理由

1. **OCR/手動入力ミス**
   - Firebase Consoleのスクリーンショット画像から目視でAPI keyを転記
   - 似た文字の誤認識
     - `W` を `M` と読み間違えた
     - `TTT` を `ITT` と読み間違えた（`T` と `I` は視覚的に類似）

2. **検証不足**
   - コピー&ペーストではなく手動入力
   - 入力後のダブルチェックを実施していなかった

### 解決方法

#### 修正内容

`.env`ファイルのAPI keyを正しい値に修正:

```diff
-VITE_FIREBASE_API_KEY=AIzaSyBroPFMQozcVEMEbITTh-1fZcS2FX4td04
+VITE_FIREBASE_API_KEY=AIzaSyBroPFWQozcVEMEbTTTh-1fZcS2FX4td04
```

#### 修正後の手順

1. `.env`ファイルを修正
2. 開発サーバーを再起動
   ```bash
   cd techgear-store
   npm run dev
   ```
3. 新しいブラウザタブで `http://localhost:5175/register` にアクセス
4. テストユーザーで新規登録を実行

#### 結果

✅ **認証成功！**
- Email/Password認証が正常に動作
- ユーザー登録が完了
- ログインが成功
- ユーザー名「新森清志」が正しく表示

### 教訓と今後の対策

#### 今回の問題から学んだこと

1. **機密情報の転記方法**
   - ❌ 画像からの目視転記 → タイプミスのリスクが高い
   - ✅ テキストのコピー&ペースト → 確実
   - ✅ Firebase CLIを使用した自動取得 → 最も確実

2. **デバッグの優先順位**
   - 複雑な原因を先に疑う前に、シンプルな入力ミスを確認すべき
   - API keyのような長い文字列は特に注意が必要

3. **検証プロセスの重要性**
   - 設定値の入力後は必ずダブルチェック
   - 可能であれば自動検証スクリプトを用意

#### 推奨される作業フロー

**Firebase設定情報の安全な取得方法:**

1. **方法1: Firebase CLIを使用（推奨）**
   ```bash
   firebase apps:sdkconfig web
   ```
   - 出力されたJSONをそのまま使用
   - 人的ミスを完全に排除

2. **方法2: Firebaseコンソールからコピー&ペースト**
   - Firebase Console > プロジェクト設定 > マイアプリ
   - 設定オブジェクトの「コピー」ボタンを使用
   - 手動入力は絶対に避ける

3. **方法3: 画像を使う場合（非推奨だが必要な場合）**
   - 高解像度のスクリーンショットを撮影
   - OCRツールで文字列を抽出
   - **必ず文字単位で照合確認**
   - 特に類似文字（I/T, O/0, M/W など）に注意

#### 検証スクリプトの例

今後のために、API key形式の検証スクリプトを用意することを推奨:

```javascript
// scripts/validate-firebase-config.js
import * as dotenv from 'dotenv';
dotenv.config();

const requiredKeys = [
  'VITE_FIREBASE_API_KEY',
  'VITE_FIREBASE_AUTH_DOMAIN',
  'VITE_FIREBASE_PROJECT_ID',
  'VITE_FIREBASE_STORAGE_BUCKET',
  'VITE_FIREBASE_MESSAGING_SENDER_ID',
  'VITE_FIREBASE_APP_ID',
];

// API keyの形式チェック
const apiKey = process.env.VITE_FIREBASE_API_KEY;
const apiKeyPattern = /^AIza[0-9A-Za-z-_]{35}$/;

if (!apiKeyPattern.test(apiKey)) {
  console.error('❌ Invalid API key format');
  process.exit(1);
}

console.log('✅ Firebase configuration is valid');
```

### タイムライン総括

| 日付 | 作業内容 | 結果 |
|------|---------|------|
| 前々セッション | 旧プロジェクトで認証エラー発生、各種対策を実施 | 失敗 |
| 前セッション | 新規Firebaseプロジェクト作成、`.env`更新 | API keyにタイプミス混入 |
| 本セッション（初期） | サーバー再起動、認証テスト | 同じエラー継続 |
| 本セッション（解決） | API keyのタイプミス発見・修正 | ✅ 認証成功 |

**問題解決にかかった総時間:** 数日間（実際の原因は単純な2文字のタイプミス）

### 現在の状態

**動作確認済み:**
- ✅ Firebase Authentication初期化
- ✅ Email/Password新規登録
- ✅ Email/Passwordログイン
- ✅ ユーザー情報の表示

**未確認（次のテスト項目）:**
- ⏸️ Google OAuth認証
- ⏸️ Firestoreへのデータ保存
- ⏸️ Storageへのファイルアップロード

### 関連ファイル

- [.env](../techgear-store/.env) - Firebase設定（修正済み）
- [firebase.ts](../techgear-store/src/lib/firebase.ts) - Firebase初期化
- [AuthContext.tsx](../techgear-store/src/contexts/AuthContext.tsx) - 認証コンテキスト
- [Register.tsx](../techgear-store/src/pages/Register.tsx) - 登録ページ

---

**結論:** 数日間にわたる複雑なトラブルシューティングの末、根本原因は`.env`ファイルのAPI keyに含まれていた2文字のタイプミスでした。画像からの手動転記ではなく、テキストのコピー&ペーストまたはCLIツールの使用が絶対に推奨されます。
