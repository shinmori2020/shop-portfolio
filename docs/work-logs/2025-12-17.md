# 作業ログ - 2025年12月17日

## 作業概要
EmailJS統合とreCAPTCHA v2セキュリティ対策の実装完了

## 実施した作業

### 1. EmailJS統合（お問い合わせフォーム機能）

#### パッケージインストール
```bash
npm install @emailjs/browser
```

#### EmailJSアカウント設定
- EmailJSアカウント作成
- Gmailサービス接続（Service ID: `service_4g1nyxo`）
- 日本語メールテンプレート作成（Template ID: `template_pryh4sj`）
- Public Key取得: `hz3oq4ufROaPWSoYV`

#### 環境変数設定
`.env`ファイルに以下を追加：
```env
VITE_EMAILJS_SERVICE_ID=service_4g1nyxo
VITE_EMAILJS_TEMPLATE_ID=template_pryh4sj
VITE_EMAILJS_PUBLIC_KEY=hz3oq4ufROaPWSoYV
```

`.gitignore`に追加：
```
# Environment variables
.env
.env.local
.env.production
```

#### About.tsxの実装
- EmailJS統合
- フォーム送信処理
- 成功/エラーメッセージ表示
- フォームリセット機能

**変更ファイル:**
- `techgear-store/src/pages/About/About.tsx`
- `techgear-store/src/pages/About/About.css`

#### テスト結果
✅ メール送信成功
✅ フォームバリデーション動作
✅ 成功メッセージ表示

---

### 2. reCAPTCHA統合（スパム対策）

#### 初期実装の試行錯誤

##### 試行1: reCAPTCHA v3 + react-google-recaptcha-v3
**問題点:**
- `Invalid site key or not loaded in api.js`エラーが継続
- サイトキーのタイポ修正（`UC4a` → `UC4s`）後も解決せず
- `useRecaptchaNet={true}`オプション追加も効果なし

**原因:**
- `react-google-recaptcha-v3`ライブラリの互換性問題
- reCAPTCHA v3の実装が複雑で不安定

##### 試行2: ライブラリ切り替え
```bash
npm uninstall react-google-recaptcha-v3
npm install react-google-recaptcha @types/react-google-recaptcha
```

- App.tsxからGoogleReCaptchaProviderを削除
- About.tsxでReCAPTCHAコンポーネントを直接使用
- `size="invisible"`で実装

**問題点:**
- `POST https://www.google.com/recaptcha/api2/reload 400 (Bad Request)`
- `react-google-recaptcha`は主にv2用で、invisibleモードとの互換性問題

#### 最終解決策: reCAPTCHA v2チェックボックス型

##### Google reCAPTCHAでv2サイト作成
- ラベル: TechGear Store v2
- reCAPTCHAタイプ: チャレンジ (v2) - 「私はロボットではありません」チェックボックス
- ドメイン: localhost
- サイトキー: `6LfmZi4sAAAAAPAZpQDs7bRw-WPJZR7IeuNUSscE`
- シークレットキー: `6LfmZi4sAAAAAFH_tS_hebIEAW0WdAItf6Qens1m`

##### .env更新
```env
VITE_RECAPTCHA_SITE_KEY=6LfmZi4sAAAAAPAZpQDs7bRw-WPJZR7IeuNUSscE
```

##### About.tsx修正
**変更点:**
- `executeAsync()` → `getValue()`に変更（v2対応）
- チェックボックス未チェック時のエラーメッセージ追加
- `size="invisible"`を削除してチェックボックス表示
- フォーム送信成功/失敗時に`recaptchaRef.current?.reset()`でreCAPTCHAをリセット

**実装コード:**
```tsx
import ReCAPTCHA from 'react-google-recaptcha';

const recaptchaRef = useRef<ReCAPTCHA>(null);

const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
  e.preventDefault();

  // reCAPTCHA v2トークンを取得
  const recaptchaToken = recaptchaRef.current.getValue();
  if (!recaptchaToken) {
    setErrorMessage('reCAPTCHAチェックボックスにチェックを入れてください。');
    setSubmitStatus('error');
    setIsSubmitting(false);
    return;
  }

  // EmailJS送信処理...

  // 成功時
  recaptchaRef.current?.reset();
};

// JSX
<ReCAPTCHA
  ref={recaptchaRef}
  sitekey={import.meta.env.VITE_RECAPTCHA_SITE_KEY}
/>
```

#### テスト結果
✅ reCAPTCHAチェックボックス表示成功
✅ チェック後にフォーム送信成功
✅ メール送信成功
✅ エラーハンドリング正常動作

---

## 問題と解決

### 問題1: reCAPTCHA v3が動作しない
**エラー:** `Invalid site key or not loaded in api.js`

**試した解決策（すべて失敗）:**
- サーバー再起動
- ブラウザ完全リロード
- サイトキーのタイポ修正
- `useRecaptchaNet={true}`オプション追加
- ライブラリ変更（react-google-recaptcha）
- invisibleモード実装

**最終解決:**
reCAPTCHA v2チェックボックス型に切り替え

**根本原因:**
`react-google-recaptcha-v3`ライブラリとreCAPTCHA v3の互換性問題

### 問題2: reCAPTCHA 400エラー
**エラー:** `POST https://www.google.com/recaptcha/api2/reload 400 (Bad Request)`

**原因:**
- `react-google-recaptcha`は主にv2用のライブラリ
- `size="invisible"`との互換性問題

**解決:**
v2チェックボックス型に切り替え

---

## 変更ファイル一覧

### 新規作成
- `techgear-store/.env`

### 修正
- `techgear-store/.gitignore`
- `techgear-store/package.json`
- `techgear-store/src/pages/About/About.tsx`
- `techgear-store/src/pages/About/About.css`

### 削除（コードから）
- `techgear-store/src/App.tsx` - GoogleReCaptchaProvider削除

---

## 導入パッケージ

```json
{
  "dependencies": {
    "@emailjs/browser": "^4.x.x",
    "react-google-recaptcha": "^1.x.x",
    "@types/react-google-recaptcha": "^2.x.x"
  }
}
```

**削除したパッケージ:**
- `react-google-recaptcha-v3`

---

## セキュリティ対策

### 実装済み
✅ reCAPTCHA v2（チェックボックス型）
✅ EmailJSフロントエンド統合
✅ 環境変数による機密情報管理
✅ .envファイルのGit除外

### EmailJS無料プランの制限
- メール送信数: 月200通まで
- ドメイン制限: 有料機能（未実装）
- reCAPTCHA統合: 有料機能（フロントエンドで実装）

---

## ユーザーからの要望

**要望:** reCAPTCHAチェックボックスがデザイン的に邪魔

**提案した選択肢:**
1. **reCAPTCHA v2 invisible** - チェックボックス非表示、怪しい場合のみ画像チャレンジ
2. **reCAPTCHA v3再挑戦** - 別ライブラリで完全不可視実装（複雑）
3. **デザイン調整** - チェックボックスの位置・余白調整

**推奨:** オプション1（v2 invisible）- バランスが良く、安定動作

---

## 次回の作業候補

### reCAPTCHAデザイン改善
- [ ] reCAPTCHA v2 invisibleモードへの移行検討
- [ ] チェックボックスのデザイン調整

### その他の改善
- [ ] フォームバリデーション強化
- [ ] メール送信エラー時のリトライ機能
- [ ] 送信履歴のローカルストレージ保存

---

## 学んだこと

1. **ライブラリ選定の重要性**
   - 人気があっても、自分の要件に合わない場合がある
   - reCAPTCHA v3は理論上優れているが、実装が複雑
   - v2チェックボックス型の方が安定している

2. **段階的デバッグの重要性**
   - サイトキーのタイポという基本的なミスもある
   - ネットワークタブ、コンソール、環境変数を順番に確認

3. **ユーザビリティとセキュリティのバランス**
   - reCAPTCHA v3は完全不可視でUX良好だが、実装が難しい
   - reCAPTCHA v2は視認性があるが、実装が簡単で安定

---

## 成果物

✅ **EmailJS統合完了** - お問い合わせフォームが実際にメール送信可能に
✅ **reCAPTCHA v2統合完了** - スパム対策実装
✅ **エラーハンドリング実装** - ユーザーフレンドリーなエラーメッセージ
✅ **セキュリティ対策** - 環境変数による機密情報管理

---

## 開発環境

- **開発サーバー:** http://localhost:5177/
- **Node.js:** v18以上
- **パッケージマネージャー:** npm
- **フレームワーク:** React + TypeScript + Vite

---

## 備考

### EmailJS無料プラン
- 月200通まで無料
- ドメイン制限・reCAPTCHA統合は有料機能
- フロントエンドでreCAPTCHA実装することで回避

### reCAPTCHA無料プラン
- v2/v3ともに月10,000リクエストまで無料
- localhost登録済み
- 本番環境デプロイ時はドメイン追加が必要

### 今後の検討事項
- reCAPTCHA v2 invisibleモードへの移行
- バックエンドでのreCAPTCHAトークン検証（セキュリティ強化）
- メール送信数の監視機能

---

## 3. reCAPTCHA v2 Invisibleモードへの移行

### ユーザーからの要望
**「reCAPTCHAチェックボックスがデザイン的に邪魔」**

### 対応方針
reCAPTCHA v2 invisible（不可視型）に切り替え
- **成功率:** 85-90%
- **作業時間:** 約15分
- チェックボックス非表示、怪しい場合のみ画像チャレンジ表示

### Google reCAPTCHA v2 Invisible設定

#### 新規サイト作成
- **ラベル:** TechGear Store v2 Invisible
- **reCAPTCHAタイプ:** チャレンジ (v2) → **非表示 reCAPTCHAバッジ**
- **ドメイン:** localhost
- **サイトキー:** `6LdPai4sAAAAAIHx7zhzm7H83vLqGiBuC8qqTlyE`
- **シークレットキー:** `6LdPai4sAAAAABWlqui_XT8LBp7bl9HdCjN4cJQF`

#### .env更新
```env
VITE_RECAPTCHA_SITE_KEY=6LdPai4sAAAAAIHx7zhzm7H83vLqGiBuC8qqTlyE
```

### コード修正

#### About.tsx修正
**変更点:**
- `getValue()` → `executeAsync()`に変更（invisible対応）
- `size="invisible"`属性を追加
- フォーム参照を`e.preventDefault()`直後に取得（重要！）

**修正後のコード:**
```tsx
const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
  e.preventDefault();

  // フォーム参照を先に取得（executeAsyncの前）
  const form = e.currentTarget;

  if (!recaptchaRef.current) {
    setErrorMessage('reCAPTCHAが読み込まれていません。ページを再読み込みしてください。');
    setSubmitStatus('error');
    return;
  }

  setIsSubmitting(true);
  setSubmitStatus('idle');
  setErrorMessage('');

  try {
    // reCAPTCHA v2 invisible - executeAsync()でトークンを取得
    const recaptchaToken = await recaptchaRef.current.executeAsync();
    if (!recaptchaToken) {
      setErrorMessage('reCAPTCHA認証に失敗しました。ページを再読み込みしてください。');
      setSubmitStatus('error');
      setIsSubmitting(false);
      return;
    }

    const formData = new FormData(form);
    // ... EmailJS送信処理
  } catch (error) {
    console.error('Form submission error:', error);
    setSubmitStatus('error');
    setErrorMessage('送信に失敗しました。しばらく時間をおいて再度お試しください。');
    recaptchaRef.current?.reset();
  } finally {
    setIsSubmitting(false);
  }
};

// JSX
<ReCAPTCHA
  ref={recaptchaRef}
  size="invisible"
  sitekey={import.meta.env.VITE_RECAPTCHA_SITE_KEY}
/>
```

### 遭遇したエラーと解決

#### エラー: FormData構築失敗
**エラーメッセージ:** `TypeError: Failed to construct 'FormData': parameter 1 is not of type 'HTMLFormElement'.`

**原因:**
`executeAsync()`を実行した後、イベントオブジェクトの`currentTarget`が失われる

**解決策:**
フォーム参照を`executeAsync()`の**前**に取得する

```tsx
// ❌ NG: executeAsync()の後にフォーム参照取得
const recaptchaToken = await recaptchaRef.current.executeAsync();
const form = e.currentTarget; // ここでformがnullになる

// ✅ OK: executeAsync()の前にフォーム参照取得
const form = e.currentTarget;
const recaptchaToken = await recaptchaRef.current.executeAsync();
```

### テスト結果
✅ reCAPTCHAチェックボックス非表示
✅ 右下に小さなreCAPTCHAバッジ表示
✅ フォーム送信成功
✅ メール送信成功
✅ エラーハンドリング正常動作

---

## 4. お問い合わせページの分離

### ユーザーからの要望
**「お問い合わせフォームをAboutページから個別のContactページに移動させたい」**

### 実装内容

#### 1. 新規Contactページ作成

**作成ファイル:**
- `techgear-store/src/pages/Contact/Contact.tsx` - メインコンポーネント
- `techgear-store/src/pages/Contact/Contact.css` - スタイル
- `techgear-store/src/pages/Contact/index.ts` - エクスポート

**Contact.tsx構成:**
```tsx
import React, { useState, FormEvent, useRef } from 'react';
import ReCAPTCHA from 'react-google-recaptcha';
import emailjs from '@emailjs/browser';
import './Contact.css';

export const Contact: React.FC = () => {
  // Aboutページから移植したフォームロジック
  const recaptchaRef = useRef<ReCAPTCHA>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [errorMessage, setErrorMessage] = useState('');

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    // ... フォーム送信処理（Aboutから移植）
  };

  return (
    <div className="contact">
      {/* ヘッダー */}
      <section className="contact__header">
        <div className="contact__container">
          <h1 className="contact__title">お問い合わせ</h1>
          <p className="contact__description">
            商品やサービスに関するご質問・ご相談は、こちらのフォームからお気軽にお問い合わせください。
            <br />
            通常、1-2営業日以内にご返信いたします。
          </p>
        </div>
      </section>

      {/* お問い合わせフォーム */}
      <section className="contact__form-section">
        <div className="contact__container">
          <form className="contact__form" onSubmit={handleSubmit}>
            {/* フォームフィールド */}
            <ReCAPTCHA
              ref={recaptchaRef}
              size="invisible"
              sitekey={import.meta.env.VITE_RECAPTCHA_SITE_KEY}
            />
            <button type="submit" className="contact__form-submit" disabled={isSubmitting}>
              {isSubmitting ? '送信中...' : '送信する'}
            </button>
          </form>
        </div>
      </section>
    </div>
  );
};
```

#### 2. ルーティング追加

**App.tsx修正:**
```tsx
import { Contact } from './pages/Contact';

// ...

<Routes>
  <Route path="/" element={<Home />} />
  <Route path="/products" element={<ProductList />} />
  <Route path="/categories" element={<Categories />} />
  <Route path="/about" element={<About />} />
  <Route path="/contact" element={<Contact />} />  {/* 追加 */}
  <Route path="/terms" element={<Terms />} />
  {/* ... */}
</Routes>
```

#### 3. ナビゲーション更新

**Header.tsx修正:**
```tsx
// デスクトップメニュー
<Link to="/contact" className="header__nav-link">
  お問い合わせ
</Link>

// モバイルメニュー
<li className="header__mobile-nav-item">
  <Link to="/contact" className="header__mobile-nav-link" onClick={closeMobileMenu}>
    お問い合わせ
  </Link>
</li>
```

**Footer.tsx修正:**
```tsx
<li>
  <Link to="/contact" className="footer__link">お問い合わせ</Link>
</li>
```

#### 4. Aboutページ調整

**About.tsx修正:**
```tsx
import { Link } from 'react-router-dom';

// フォーム関連のインポートを削除
// - useState, FormEvent, useRef削除
// - emailjs, ReCAPTCHA削除

// フォーム関連のstate/関数を削除
// - recaptchaRef削除
// - isSubmitting, submitStatus, errorMessage削除
// - handleSubmit削除

// お問い合わせセクションをシンプルなリンクに変更
<section className="about__contact">
  <div className="about__container">
    <h2 className="about__section-title">お問い合わせ</h2>
    <p className="about__contact-text">
      商品やサービスに関するご質問・ご相談がございましたら、お気軽にお問い合わせください。
    </p>
    <Link to="/contact" className="about__contact-button">
      お問い合わせフォームはこちら
    </Link>
  </div>
</section>
```

**About.css追加:**
```css
.about__contact-text {
  text-align: center;
  font-size: 16px;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-xl);
  line-height: 1.8;
}

.about__contact-button {
  display: inline-block;
  padding: var(--spacing-md) var(--spacing-2xl);
  font-size: 18px;
  font-weight: 700;
  color: white;
  background: #000;
  border: 2px solid #000;
  text-decoration: none;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: 'Rajdhani', sans-serif;
  margin: 0 auto;
  display: block;
  width: fit-content;
}

.about__contact-button:hover {
  background: white;
  color: #000;
}
```

### 遭遇したエラーと解決

#### エラー: モジュールが見つからない
**エラーメッセージ:** `Failed to resolve import "./pages/Contact" from "src/App.tsx". Does the file exist?`

**原因:**
`index.ts`（エクスポートファイル）が存在しない

**解決策:**
`src/pages/Contact/index.ts`を作成
```ts
export { Contact } from './Contact';
```

### 変更ファイル一覧

#### 新規作成
- `techgear-store/src/pages/Contact/Contact.tsx`
- `techgear-store/src/pages/Contact/Contact.css`
- `techgear-store/src/pages/Contact/index.ts`

#### 修正
- `techgear-store/src/App.tsx` - Contactインポートとルート追加
- `techgear-store/src/components/layouts/Header/Header.tsx` - ナビゲーション追加
- `techgear-store/src/components/layouts/Footer/Footer.tsx` - フッターリンク追加
- `techgear-store/src/pages/About/About.tsx` - フォーム削除、リンクに変更
- `techgear-store/src/pages/About/About.css` - ボタンスタイル追加

### テスト結果
✅ `/contact`ページが正常に表示
✅ お問い合わせフォームが動作（reCAPTCHA invisible含む）
✅ メール送信成功
✅ Aboutページがシンプルな会社情報ページに変更
✅ 「お問い合わせフォームはこちら」ボタンから遷移可能
✅ Header/Footerのナビゲーションリンク動作

### メリット
✅ **明確なページ分離** - About = 会社情報、Contact = お問い合わせ
✅ **ユーザビリティ向上** - 目的に応じてページを直接アクセス可能
✅ **SEO改善** - `/contact`ページが独立して検索エンジンにインデックス
✅ **保守性向上** - フォームロジックが独立、変更が容易

---

## 最終成果物

### 完成した機能
1. ✅ **EmailJS統合** - お問い合わせフォームが実際にメール送信可能
2. ✅ **reCAPTCHA v2 Invisible統合** - チェックボックス非表示のスパム対策
3. ✅ **独立したContactページ** - `/contact`でアクセス可能
4. ✅ **Aboutページの最適化** - 会社情報に特化
5. ✅ **ナビゲーション整備** - Header/Footerに「お問い合わせ」リンク追加

### セキュリティ対策
✅ reCAPTCHA v2 Invisible（バックグラウンド動作）
✅ 環境変数による機密情報管理（.env）
✅ .envファイルのGit除外

### 技術スタック
- **EmailJS:** メール送信サービス（無料プラン200通/月）
- **Google reCAPTCHA v2 Invisible:** スパム対策（無料プラン10,000リクエスト/月）
- **react-google-recaptcha:** reCAPTCHA v2用Reactライブラリ
- **React Router:** ページルーティング

### 開発環境
- **開発サーバー:** http://localhost:5178/
- **主要ページ:**
  - `/about` - 会社概要
  - `/contact` - お問い合わせフォーム（EmailJS + reCAPTCHA）

---

## 今後の改善案

### セキュリティ強化
- [ ] バックエンドでのreCAPTCHAトークン検証
- [ ] レート制限の実装
- [ ] メール送信数の監視・アラート機能

### UX改善
- [ ] フォーム入力の自動保存（LocalStorage）
- [ ] 送信完了後の確認ページ
- [ ] 多言語対応（英語・日本語切り替え）

### 機能追加
- [ ] お問い合わせ履歴の管理画面
- [ ] 自動返信メール機能
- [ ] 添付ファイル対応

---

## 学んだこと（追加）

### reCAPTCHA実装の注意点
1. **v3とv2の違い**
   - v3: 完全不可視、スコアベース、実装複雑
   - v2: チェックボックスまたはinvisible、シンプル、安定

2. **Invisibleモードの落とし穴**
   - `executeAsync()`は非同期なので、イベント参照が失われる
   - フォーム参照は`executeAsync()`の**前**に取得必須

3. **ライブラリ選定**
   - `react-google-recaptcha-v3`: v3専用だが不安定
   - `react-google-recaptcha`: v2専用、安定、invisibleモード対応

### ページ分離のベストプラクティス
1. **責任の明確化** - 1ページ1目的の原則
2. **index.tsの重要性** - モジュール解決のためのエクスポートファイル
3. **段階的な移行** - 既存コードのコピー→新ページ作成→旧ページクリーンアップ

---

## 作業時間

- **EmailJS統合:** 約30分
- **reCAPTCHA v3試行錯誤:** 約1時間（失敗）
- **reCAPTCHA v2チェックボックス実装:** 約20分
- **reCAPTCHA v2 Invisible移行:** 約15分
- **Contactページ分離:** 約20分
- **合計:** 約2時間25分

---

## 最終確認事項

### 動作確認済み
✅ `/contact`ページ正常表示
✅ reCAPTCHA invisible動作
✅ メール送信成功（kiyoshi315jp@gmail.comに受信確認）
✅ Aboutページのリンク動作
✅ Header/Footerナビゲーション動作

### 残タスク
なし - すべて完了
