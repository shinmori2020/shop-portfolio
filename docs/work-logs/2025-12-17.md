# 作業ログ - 2025年12月17日

## 作業概要
EmailJS統合とreCAPTCHA v2セキュリティ対策の実装完了

## 実施した作業

### 1. EmailJS統合（お問い合わせフォーム機能）

#### パッケージインストール
```bash
npm install @emailjs/browser
```

#### EmailJSアカウント設定
- EmailJSアカウント作成
- Gmailサービス接続（Service ID: `service_4g1nyxo`）
- 日本語メールテンプレート作成（Template ID: `template_pryh4sj`）
- Public Key取得: `hz3oq4ufROaPWSoYV`

#### 環境変数設定
`.env`ファイルに以下を追加：
```env
VITE_EMAILJS_SERVICE_ID=service_4g1nyxo
VITE_EMAILJS_TEMPLATE_ID=template_pryh4sj
VITE_EMAILJS_PUBLIC_KEY=hz3oq4ufROaPWSoYV
```

`.gitignore`に追加：
```
# Environment variables
.env
.env.local
.env.production
```

#### About.tsxの実装
- EmailJS統合
- フォーム送信処理
- 成功/エラーメッセージ表示
- フォームリセット機能

**変更ファイル:**
- `techgear-store/src/pages/About/About.tsx`
- `techgear-store/src/pages/About/About.css`

#### テスト結果
✅ メール送信成功
✅ フォームバリデーション動作
✅ 成功メッセージ表示

---

### 2. reCAPTCHA統合（スパム対策）

#### 初期実装の試行錯誤

##### 試行1: reCAPTCHA v3 + react-google-recaptcha-v3
**問題点:**
- `Invalid site key or not loaded in api.js`エラーが継続
- サイトキーのタイポ修正（`UC4a` → `UC4s`）後も解決せず
- `useRecaptchaNet={true}`オプション追加も効果なし

**原因:**
- `react-google-recaptcha-v3`ライブラリの互換性問題
- reCAPTCHA v3の実装が複雑で不安定

##### 試行2: ライブラリ切り替え
```bash
npm uninstall react-google-recaptcha-v3
npm install react-google-recaptcha @types/react-google-recaptcha
```

- App.tsxからGoogleReCaptchaProviderを削除
- About.tsxでReCAPTCHAコンポーネントを直接使用
- `size="invisible"`で実装

**問題点:**
- `POST https://www.google.com/recaptcha/api2/reload 400 (Bad Request)`
- `react-google-recaptcha`は主にv2用で、invisibleモードとの互換性問題

#### 最終解決策: reCAPTCHA v2チェックボックス型

##### Google reCAPTCHAでv2サイト作成
- ラベル: TechGear Store v2
- reCAPTCHAタイプ: チャレンジ (v2) - 「私はロボットではありません」チェックボックス
- ドメイン: localhost
- サイトキー: `6LfmZi4sAAAAAPAZpQDs7bRw-WPJZR7IeuNUSscE`
- シークレットキー: `6LfmZi4sAAAAAFH_tS_hebIEAW0WdAItf6Qens1m`

##### .env更新
```env
VITE_RECAPTCHA_SITE_KEY=6LfmZi4sAAAAAPAZpQDs7bRw-WPJZR7IeuNUSscE
```

##### About.tsx修正
**変更点:**
- `executeAsync()` → `getValue()`に変更（v2対応）
- チェックボックス未チェック時のエラーメッセージ追加
- `size="invisible"`を削除してチェックボックス表示
- フォーム送信成功/失敗時に`recaptchaRef.current?.reset()`でreCAPTCHAをリセット

**実装コード:**
```tsx
import ReCAPTCHA from 'react-google-recaptcha';

const recaptchaRef = useRef<ReCAPTCHA>(null);

const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
  e.preventDefault();

  // reCAPTCHA v2トークンを取得
  const recaptchaToken = recaptchaRef.current.getValue();
  if (!recaptchaToken) {
    setErrorMessage('reCAPTCHAチェックボックスにチェックを入れてください。');
    setSubmitStatus('error');
    setIsSubmitting(false);
    return;
  }

  // EmailJS送信処理...

  // 成功時
  recaptchaRef.current?.reset();
};

// JSX
<ReCAPTCHA
  ref={recaptchaRef}
  sitekey={import.meta.env.VITE_RECAPTCHA_SITE_KEY}
/>
```

#### テスト結果
✅ reCAPTCHAチェックボックス表示成功
✅ チェック後にフォーム送信成功
✅ メール送信成功
✅ エラーハンドリング正常動作

---

## 問題と解決

### 問題1: reCAPTCHA v3が動作しない
**エラー:** `Invalid site key or not loaded in api.js`

**試した解決策（すべて失敗）:**
- サーバー再起動
- ブラウザ完全リロード
- サイトキーのタイポ修正
- `useRecaptchaNet={true}`オプション追加
- ライブラリ変更（react-google-recaptcha）
- invisibleモード実装

**最終解決:**
reCAPTCHA v2チェックボックス型に切り替え

**根本原因:**
`react-google-recaptcha-v3`ライブラリとreCAPTCHA v3の互換性問題

### 問題2: reCAPTCHA 400エラー
**エラー:** `POST https://www.google.com/recaptcha/api2/reload 400 (Bad Request)`

**原因:**
- `react-google-recaptcha`は主にv2用のライブラリ
- `size="invisible"`との互換性問題

**解決:**
v2チェックボックス型に切り替え

---

## 変更ファイル一覧

### 新規作成
- `techgear-store/.env`

### 修正
- `techgear-store/.gitignore`
- `techgear-store/package.json`
- `techgear-store/src/pages/About/About.tsx`
- `techgear-store/src/pages/About/About.css`

### 削除（コードから）
- `techgear-store/src/App.tsx` - GoogleReCaptchaProvider削除

---

## 導入パッケージ

```json
{
  "dependencies": {
    "@emailjs/browser": "^4.x.x",
    "react-google-recaptcha": "^1.x.x",
    "@types/react-google-recaptcha": "^2.x.x"
  }
}
```

**削除したパッケージ:**
- `react-google-recaptcha-v3`

---

## セキュリティ対策

### 実装済み
✅ reCAPTCHA v2（チェックボックス型）
✅ EmailJSフロントエンド統合
✅ 環境変数による機密情報管理
✅ .envファイルのGit除外

### EmailJS無料プランの制限
- メール送信数: 月200通まで
- ドメイン制限: 有料機能（未実装）
- reCAPTCHA統合: 有料機能（フロントエンドで実装）

---

## ユーザーからの要望

**要望:** reCAPTCHAチェックボックスがデザイン的に邪魔

**提案した選択肢:**
1. **reCAPTCHA v2 invisible** - チェックボックス非表示、怪しい場合のみ画像チャレンジ
2. **reCAPTCHA v3再挑戦** - 別ライブラリで完全不可視実装（複雑）
3. **デザイン調整** - チェックボックスの位置・余白調整

**推奨:** オプション1（v2 invisible）- バランスが良く、安定動作

---

## 次回の作業候補

### reCAPTCHAデザイン改善
- [ ] reCAPTCHA v2 invisibleモードへの移行検討
- [ ] チェックボックスのデザイン調整

### その他の改善
- [ ] フォームバリデーション強化
- [ ] メール送信エラー時のリトライ機能
- [ ] 送信履歴のローカルストレージ保存

---

## 学んだこと

1. **ライブラリ選定の重要性**
   - 人気があっても、自分の要件に合わない場合がある
   - reCAPTCHA v3は理論上優れているが、実装が複雑
   - v2チェックボックス型の方が安定している

2. **段階的デバッグの重要性**
   - サイトキーのタイポという基本的なミスもある
   - ネットワークタブ、コンソール、環境変数を順番に確認

3. **ユーザビリティとセキュリティのバランス**
   - reCAPTCHA v3は完全不可視でUX良好だが、実装が難しい
   - reCAPTCHA v2は視認性があるが、実装が簡単で安定

---

## 成果物

✅ **EmailJS統合完了** - お問い合わせフォームが実際にメール送信可能に
✅ **reCAPTCHA v2統合完了** - スパム対策実装
✅ **エラーハンドリング実装** - ユーザーフレンドリーなエラーメッセージ
✅ **セキュリティ対策** - 環境変数による機密情報管理

---

## 開発環境

- **開発サーバー:** http://localhost:5177/
- **Node.js:** v18以上
- **パッケージマネージャー:** npm
- **フレームワーク:** React + TypeScript + Vite

---

## 備考

### EmailJS無料プラン
- 月200通まで無料
- ドメイン制限・reCAPTCHA統合は有料機能
- フロントエンドでreCAPTCHA実装することで回避

### reCAPTCHA無料プラン
- v2/v3ともに月10,000リクエストまで無料
- localhost登録済み
- 本番環境デプロイ時はドメイン追加が必要

### 今後の検討事項
- reCAPTCHA v2 invisibleモードへの移行
- バックエンドでのreCAPTCHAトークン検証（セキュリティ強化）
- メール送信数の監視機能

---

## 3. reCAPTCHA v2 Invisibleモードへの移行

### ユーザーからの要望
**「reCAPTCHAチェックボックスがデザイン的に邪魔」**

### 対応方針
reCAPTCHA v2 invisible（不可視型）に切り替え
- **成功率:** 85-90%
- **作業時間:** 約15分
- チェックボックス非表示、怪しい場合のみ画像チャレンジ表示

### Google reCAPTCHA v2 Invisible設定

#### 新規サイト作成
- **ラベル:** TechGear Store v2 Invisible
- **reCAPTCHAタイプ:** チャレンジ (v2) → **非表示 reCAPTCHAバッジ**
- **ドメイン:** localhost
- **サイトキー:** `6LdPai4sAAAAAIHx7zhzm7H83vLqGiBuC8qqTlyE`
- **シークレットキー:** `6LdPai4sAAAAABWlqui_XT8LBp7bl9HdCjN4cJQF`

#### .env更新
```env
VITE_RECAPTCHA_SITE_KEY=6LdPai4sAAAAAIHx7zhzm7H83vLqGiBuC8qqTlyE
```

### コード修正

#### About.tsx修正
**変更点:**
- `getValue()` → `executeAsync()`に変更（invisible対応）
- `size="invisible"`属性を追加
- フォーム参照を`e.preventDefault()`直後に取得（重要！）

**修正後のコード:**
```tsx
const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
  e.preventDefault();

  // フォーム参照を先に取得（executeAsyncの前）
  const form = e.currentTarget;

  if (!recaptchaRef.current) {
    setErrorMessage('reCAPTCHAが読み込まれていません。ページを再読み込みしてください。');
    setSubmitStatus('error');
    return;
  }

  setIsSubmitting(true);
  setSubmitStatus('idle');
  setErrorMessage('');

  try {
    // reCAPTCHA v2 invisible - executeAsync()でトークンを取得
    const recaptchaToken = await recaptchaRef.current.executeAsync();
    if (!recaptchaToken) {
      setErrorMessage('reCAPTCHA認証に失敗しました。ページを再読み込みしてください。');
      setSubmitStatus('error');
      setIsSubmitting(false);
      return;
    }

    const formData = new FormData(form);
    // ... EmailJS送信処理
  } catch (error) {
    console.error('Form submission error:', error);
    setSubmitStatus('error');
    setErrorMessage('送信に失敗しました。しばらく時間をおいて再度お試しください。');
    recaptchaRef.current?.reset();
  } finally {
    setIsSubmitting(false);
  }
};

// JSX
<ReCAPTCHA
  ref={recaptchaRef}
  size="invisible"
  sitekey={import.meta.env.VITE_RECAPTCHA_SITE_KEY}
/>
```

### 遭遇したエラーと解決

#### エラー: FormData構築失敗
**エラーメッセージ:** `TypeError: Failed to construct 'FormData': parameter 1 is not of type 'HTMLFormElement'.`

**原因:**
`executeAsync()`を実行した後、イベントオブジェクトの`currentTarget`が失われる

**解決策:**
フォーム参照を`executeAsync()`の**前**に取得する

```tsx
// ❌ NG: executeAsync()の後にフォーム参照取得
const recaptchaToken = await recaptchaRef.current.executeAsync();
const form = e.currentTarget; // ここでformがnullになる

// ✅ OK: executeAsync()の前にフォーム参照取得
const form = e.currentTarget;
const recaptchaToken = await recaptchaRef.current.executeAsync();
```

### テスト結果
✅ reCAPTCHAチェックボックス非表示
✅ 右下に小さなreCAPTCHAバッジ表示
✅ フォーム送信成功
✅ メール送信成功
✅ エラーハンドリング正常動作

---

## 4. お問い合わせページの分離

### ユーザーからの要望
**「お問い合わせフォームをAboutページから個別のContactページに移動させたい」**

### 実装内容

#### 1. 新規Contactページ作成

**作成ファイル:**
- `techgear-store/src/pages/Contact/Contact.tsx` - メインコンポーネント
- `techgear-store/src/pages/Contact/Contact.css` - スタイル
- `techgear-store/src/pages/Contact/index.ts` - エクスポート

**Contact.tsx構成:**
```tsx
import React, { useState, FormEvent, useRef } from 'react';
import ReCAPTCHA from 'react-google-recaptcha';
import emailjs from '@emailjs/browser';
import './Contact.css';

export const Contact: React.FC = () => {
  // Aboutページから移植したフォームロジック
  const recaptchaRef = useRef<ReCAPTCHA>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [errorMessage, setErrorMessage] = useState('');

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    // ... フォーム送信処理（Aboutから移植）
  };

  return (
    <div className="contact">
      {/* ヘッダー */}
      <section className="contact__header">
        <div className="contact__container">
          <h1 className="contact__title">お問い合わせ</h1>
          <p className="contact__description">
            商品やサービスに関するご質問・ご相談は、こちらのフォームからお気軽にお問い合わせください。
            <br />
            通常、1-2営業日以内にご返信いたします。
          </p>
        </div>
      </section>

      {/* お問い合わせフォーム */}
      <section className="contact__form-section">
        <div className="contact__container">
          <form className="contact__form" onSubmit={handleSubmit}>
            {/* フォームフィールド */}
            <ReCAPTCHA
              ref={recaptchaRef}
              size="invisible"
              sitekey={import.meta.env.VITE_RECAPTCHA_SITE_KEY}
            />
            <button type="submit" className="contact__form-submit" disabled={isSubmitting}>
              {isSubmitting ? '送信中...' : '送信する'}
            </button>
          </form>
        </div>
      </section>
    </div>
  );
};
```

#### 2. ルーティング追加

**App.tsx修正:**
```tsx
import { Contact } from './pages/Contact';

// ...

<Routes>
  <Route path="/" element={<Home />} />
  <Route path="/products" element={<ProductList />} />
  <Route path="/categories" element={<Categories />} />
  <Route path="/about" element={<About />} />
  <Route path="/contact" element={<Contact />} />  {/* 追加 */}
  <Route path="/terms" element={<Terms />} />
  {/* ... */}
</Routes>
```

#### 3. ナビゲーション更新

**Header.tsx修正:**
```tsx
// デスクトップメニュー
<Link to="/contact" className="header__nav-link">
  お問い合わせ
</Link>

// モバイルメニュー
<li className="header__mobile-nav-item">
  <Link to="/contact" className="header__mobile-nav-link" onClick={closeMobileMenu}>
    お問い合わせ
  </Link>
</li>
```

**Footer.tsx修正:**
```tsx
<li>
  <Link to="/contact" className="footer__link">お問い合わせ</Link>
</li>
```

#### 4. Aboutページ調整

**About.tsx修正:**
```tsx
import { Link } from 'react-router-dom';

// フォーム関連のインポートを削除
// - useState, FormEvent, useRef削除
// - emailjs, ReCAPTCHA削除

// フォーム関連のstate/関数を削除
// - recaptchaRef削除
// - isSubmitting, submitStatus, errorMessage削除
// - handleSubmit削除

// お問い合わせセクションをシンプルなリンクに変更
<section className="about__contact">
  <div className="about__container">
    <h2 className="about__section-title">お問い合わせ</h2>
    <p className="about__contact-text">
      商品やサービスに関するご質問・ご相談がございましたら、お気軽にお問い合わせください。
    </p>
    <Link to="/contact" className="about__contact-button">
      お問い合わせフォームはこちら
    </Link>
  </div>
</section>
```

**About.css追加:**
```css
.about__contact-text {
  text-align: center;
  font-size: 16px;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-xl);
  line-height: 1.8;
}

.about__contact-button {
  display: inline-block;
  padding: var(--spacing-md) var(--spacing-2xl);
  font-size: 18px;
  font-weight: 700;
  color: white;
  background: #000;
  border: 2px solid #000;
  text-decoration: none;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: 'Rajdhani', sans-serif;
  margin: 0 auto;
  display: block;
  width: fit-content;
}

.about__contact-button:hover {
  background: white;
  color: #000;
}
```

### 遭遇したエラーと解決

#### エラー: モジュールが見つからない
**エラーメッセージ:** `Failed to resolve import "./pages/Contact" from "src/App.tsx". Does the file exist?`

**原因:**
`index.ts`（エクスポートファイル）が存在しない

**解決策:**
`src/pages/Contact/index.ts`を作成
```ts
export { Contact } from './Contact';
```

### 変更ファイル一覧

#### 新規作成
- `techgear-store/src/pages/Contact/Contact.tsx`
- `techgear-store/src/pages/Contact/Contact.css`
- `techgear-store/src/pages/Contact/index.ts`

#### 修正
- `techgear-store/src/App.tsx` - Contactインポートとルート追加
- `techgear-store/src/components/layouts/Header/Header.tsx` - ナビゲーション追加
- `techgear-store/src/components/layouts/Footer/Footer.tsx` - フッターリンク追加
- `techgear-store/src/pages/About/About.tsx` - フォーム削除、リンクに変更
- `techgear-store/src/pages/About/About.css` - ボタンスタイル追加

### テスト結果
✅ `/contact`ページが正常に表示
✅ お問い合わせフォームが動作（reCAPTCHA invisible含む）
✅ メール送信成功
✅ Aboutページがシンプルな会社情報ページに変更
✅ 「お問い合わせフォームはこちら」ボタンから遷移可能
✅ Header/Footerのナビゲーションリンク動作

### メリット
✅ **明確なページ分離** - About = 会社情報、Contact = お問い合わせ
✅ **ユーザビリティ向上** - 目的に応じてページを直接アクセス可能
✅ **SEO改善** - `/contact`ページが独立して検索エンジンにインデックス
✅ **保守性向上** - フォームロジックが独立、変更が容易

---

## 最終成果物

### 完成した機能
1. ✅ **EmailJS統合** - お問い合わせフォームが実際にメール送信可能
2. ✅ **reCAPTCHA v2 Invisible統合** - チェックボックス非表示のスパム対策
3. ✅ **独立したContactページ** - `/contact`でアクセス可能
4. ✅ **Aboutページの最適化** - 会社情報に特化
5. ✅ **ナビゲーション整備** - Header/Footerに「お問い合わせ」リンク追加

### セキュリティ対策
✅ reCAPTCHA v2 Invisible（バックグラウンド動作）
✅ 環境変数による機密情報管理（.env）
✅ .envファイルのGit除外

### 技術スタック
- **EmailJS:** メール送信サービス（無料プラン200通/月）
- **Google reCAPTCHA v2 Invisible:** スパム対策（無料プラン10,000リクエスト/月）
- **react-google-recaptcha:** reCAPTCHA v2用Reactライブラリ
- **React Router:** ページルーティング

### 開発環境
- **開発サーバー:** http://localhost:5178/
- **主要ページ:**
  - `/about` - 会社概要
  - `/contact` - お問い合わせフォーム（EmailJS + reCAPTCHA）

---

## 今後の改善案

### セキュリティ強化
- [ ] バックエンドでのreCAPTCHAトークン検証
- [ ] レート制限の実装
- [ ] メール送信数の監視・アラート機能

### UX改善
- [ ] フォーム入力の自動保存（LocalStorage）
- [ ] 送信完了後の確認ページ
- [ ] 多言語対応（英語・日本語切り替え）

### 機能追加
- [ ] お問い合わせ履歴の管理画面
- [ ] 自動返信メール機能
- [ ] 添付ファイル対応

---

## 学んだこと（追加）

### reCAPTCHA実装の注意点
1. **v3とv2の違い**
   - v3: 完全不可視、スコアベース、実装複雑
   - v2: チェックボックスまたはinvisible、シンプル、安定

2. **Invisibleモードの落とし穴**
   - `executeAsync()`は非同期なので、イベント参照が失われる
   - フォーム参照は`executeAsync()`の**前**に取得必須

3. **ライブラリ選定**
   - `react-google-recaptcha-v3`: v3専用だが不安定
   - `react-google-recaptcha`: v2専用、安定、invisibleモード対応

### ページ分離のベストプラクティス
1. **責任の明確化** - 1ページ1目的の原則
2. **index.tsの重要性** - モジュール解決のためのエクスポートファイル
3. **段階的な移行** - 既存コードのコピー→新ページ作成→旧ページクリーンアップ

---

## 作業時間

- **EmailJS統合:** 約30分
- **reCAPTCHA v3試行錯誤:** 約1時間（失敗）
- **reCAPTCHA v2チェックボックス実装:** 約20分
- **reCAPTCHA v2 Invisible移行:** 約15分
- **Contactページ分離:** 約20分
- **合計:** 約2時間25分

---

## 最終確認事項

### 動作確認済み
✅ `/contact`ページ正常表示
✅ reCAPTCHA invisible動作
✅ メール送信成功（kiyoshi315jp@gmail.comに受信確認）
✅ Aboutページのリンク動作
✅ Header/Footerナビゲーション動作

### 残タスク
なし - すべて完了

---

## 5. セキュリティ強化機能の実装

### ユーザーからの要望
**「セキュリティ強化（レート制限、バリデーション、スパムフィルター等）を実装してほしい」**

### 実装内容

#### 1. レート制限（Rate Limiting）

**仕様:**
- 1時間以内に3回まで送信可能
- LocalStorageで送信履歴を管理
- 制限超過時は次回送信可能時刻を表示

**実装コード（Contact.tsx）:**
```tsx
// レート制限の設定
const RATE_LIMIT_MAX = 3;
const RATE_LIMIT_WINDOW = 60 * 60 * 1000; // 1時間
const STORAGE_KEY = 'contact_submissions';

interface SubmissionHistory {
  timestamps: string[];
}

const [remainingSubmissions, setRemainingSubmissions] = useState(RATE_LIMIT_MAX);

// レート制限のチェック
const checkRateLimit = (): { allowed: boolean; message?: string; nextAvailableTime?: Date } => {
  const historyStr = localStorage.getItem(STORAGE_KEY);
  if (!historyStr) return { allowed: true };

  const history: SubmissionHistory = JSON.parse(historyStr);
  const now = Date.now();
  const windowStart = now - RATE_LIMIT_WINDOW;

  const recentSubmissions = history.timestamps.filter(
    (timestamp) => new Date(timestamp).getTime() > windowStart
  );

  if (recentSubmissions.length >= RATE_LIMIT_MAX) {
    const oldestSubmission = new Date(recentSubmissions[0]);
    const nextAvailable = new Date(oldestSubmission.getTime() + RATE_LIMIT_WINDOW);

    return {
      allowed: false,
      message: `送信回数の上限に達しました。次回送信可能時刻: ${nextAvailable.toLocaleString('ja-JP')}`,
      nextAvailableTime: nextAvailable,
    };
  }

  return { allowed: true };
};

// 送信履歴を更新
const updateSubmissionHistory = () => {
  const historyStr = localStorage.getItem(STORAGE_KEY);
  const history: SubmissionHistory = historyStr ? JSON.parse(historyStr) : { timestamps: [] };
  history.timestamps.push(new Date().toISOString());
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  setRemainingSubmissions(Math.max(0, RATE_LIMIT_MAX - history.timestamps.length));
};
```

**UI表示:**
```tsx
{remainingSubmissions < RATE_LIMIT_MAX && (
  <p className="contact__rate-limit-info">
    残り送信可能回数: {remainingSubmissions}/{RATE_LIMIT_MAX} (1時間以内)
  </p>
)}
```

#### 2. フォームバリデーション強化

**検証項目:**
- メールアドレス形式チェック（正規表現）
- 電話番号形式チェック（数字、ハイフン、括弧のみ）
- メッセージ最小文字数チェック（10文字以上）
- スパムキーワード検出

**実装コード:**
```tsx
const validateForm = (formData: FormData): { valid: boolean; error?: string } => {
  const email = formData.get('email') as string;
  const phone = formData.get('phone') as string;
  const message = formData.get('message') as string;
  const subject = formData.get('subject') as string;

  // メールアドレス形式チェック
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return { valid: false, error: 'メールアドレスの形式が正しくありません。' };
  }

  // 電話番号形式チェック
  if (phone) {
    const phoneRegex = /^[0-9\-\(\)\s]+$/;
    if (!phoneRegex.test(phone)) {
      return { valid: false, error: '電話番号は数字、ハイフン、括弧のみ使用できます。' };
    }
  }

  // メッセージの最小文字数チェック
  if (message.length < 10) {
    return { valid: false, error: 'お問い合わせ内容は10文字以上入力してください。' };
  }

  // スパムチェック
  if (checkSpamContent(message) || checkSpamContent(subject)) {
    return { valid: false, error: '不適切な内容が含まれています。' };
  }

  return { valid: true };
};
```

#### 3. スパムフィルター

**禁止キーワードリスト:**
```tsx
const SPAM_KEYWORDS = ['viagra', 'casino', 'lottery', 'winner', 'free money', 'click here'];

const checkSpamContent = (text: string): boolean => {
  const lowerText = text.toLowerCase();
  return SPAM_KEYWORDS.some(keyword => lowerText.includes(keyword));
};
```

#### 4. Honeypot（ハニーポット）

**仕様:**
- ボット検知用の隠しフィールド
- 人間には見えないが、ボットが自動入力してしまう
- 入力があった場合は送信を偽装成功させる

**実装コード:**
```tsx
// JSX - 隠しフィールド
<input
  type="text"
  name="website"
  id="website"
  style={{ position: 'absolute', left: '-9999px', width: '1px', height: '1px' }}
  tabIndex={-1}
  autoComplete="off"
  aria-hidden="true"
/>

// handleSubmitでチェック
const honeypot = formData.get('website') as string;
if (honeypot) {
  // ボットを検知 - 成功したように見せかける
  setSubmitStatus('success');
  form.reset();
  return;
}
```

#### 5. リアルタイムバリデーション（onBlur）

**仕様:**
- 各フィールドからフォーカスが離れた時にバリデーション実行
- エラーがある場合は即座に吹き出しで表示
- ブラウザデフォルト風のグレー配色

**実装コード:**
```tsx
// フィールドごとのエラーメッセージstate
const [fieldErrors, setFieldErrors] = useState({
  email: '',
  phone: '',
  message: '',
  subject: ''
});

// フィールド単体のバリデーション
const validateField = (fieldName: string, value: string): string => {
  switch (fieldName) {
    case 'email':
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!value) return '';
      if (!emailRegex.test(value)) {
        return 'メールアドレスの形式が正しくありません。';
      }
      return '';

    case 'phone':
      if (!value) return '';
      const phoneRegex = /^[0-9\-\(\)\s]+$/;
      if (!phoneRegex.test(value)) {
        return '電話番号は数字、ハイフン、括弧のみ使用できます。';
      }
      return '';

    case 'message':
      if (!value) return '';
      if (value.length < 10) {
        return 'お問い合わせ内容は10文字以上入力してください。';
      }
      if (checkSpamContent(value)) {
        return '不適切な内容が含まれています。';
      }
      return '';

    case 'subject':
      if (!value) return '';
      if (checkSpamContent(value)) {
        return '不適切な内容が含まれています。';
      }
      return '';

    default:
      return '';
  }
};

// フィールドのBlurイベントハンドラ
const handleFieldBlur = (e: React.FocusEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
  const { name, value } = e.target;
  const error = validateField(name, value);
  setFieldErrors(prev => ({ ...prev, [name]: error }));
};
```

**JSX - エラー表示:**
```tsx
<input
  type="email"
  id="email"
  name="email"
  className={`contact__form-input ${fieldErrors.email ? 'contact__form-input--error' : ''}`}
  required
  onBlur={handleFieldBlur}
/>
{fieldErrors.email && (
  <span className="contact__form-error">{fieldErrors.email}</span>
)}
```

**CSS - 吹き出しスタイル:**
```css
/* フィールドエラー表示 - ブラウザデフォルト風の吹き出し */
.contact__form-group {
  position: relative;
  margin-bottom: var(--spacing-lg);
}

.contact__form-error {
  position: absolute;
  top: calc(100% + 8px);
  left: 12px;
  background: #f5f5f5;
  color: #333;
  font-size: 13px;
  padding: 10px 14px;
  border: 1px solid #666;
  border-radius: 0;
  font-weight: 400;
  width: max-content;
  white-space: nowrap;
  z-index: 10;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  animation: errorFadeIn 0.2s ease-out;
  line-height: 1.4;
  text-align: left;
}

/* 吹き出しの矢印（上向き） */
.contact__form-error::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 20px;
  border: 8px solid transparent;
  border-bottom-color: #666;
}

.contact__form-error::after {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 21px;
  border: 7px solid transparent;
  border-bottom-color: #f5f5f5;
}

.contact__form-input--error,
.contact__form-textarea--error {
  border-color: #555 !important;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .contact__form-error {
    font-size: 11px;
    padding: 8px 10px;
    white-space: normal;
    max-width: calc(100vw - 80px);
    left: 8px;
    word-break: break-word;
    line-height: 1.3;
  }
}
```

### セキュリティ機能の動作順序

```
送信ボタンクリック
    ↓
1. Honeypotチェック → ボット検知なら偽装成功
    ↓
2. レート制限チェック → 超過ならエラー表示
    ↓
3. reCAPTCHA読み込み確認
    ↓
4. バリデーションチェック
   - メール形式
   - 電話番号形式
   - メッセージ最小文字数
   - スパムキーワード
    ↓
5. reCAPTCHA実行（トークン取得）
    ↓
6. EmailJS送信
    ↓
7. 送信履歴に記録（LocalStorage）
```

### テスト方法

#### テスト1: 通常送信
✅ すべての項目を正しく入力して送信成功

#### テスト2: レート制限
✅ 3回送信後、4回目はエラー表示
✅ LocalStorageリセット後、再び送信可能

#### テスト3: バリデーション - メールアドレス
✅ 「test」と入力してフォーカス移動 → エラー吹き出し表示

#### テスト4: バリデーション - 電話番号
✅ 「abc123」と入力してフォーカス移動 → エラー吹き出し表示

#### テスト5: バリデーション - 短いメッセージ
✅ 「test」（10文字未満）と入力 → エラー吹き出し表示

#### テスト6: スパムフィルター
✅ 「viagra」などの禁止ワード入力 → エラー表示

#### テスト7: Honeypot（ボット検知）
✅ 開発者ツールで隠しフィールドに値を入力 → 偽装成功（実際は送信されない）

#### テスト8: レスポンシブ
✅ モバイルビュー（768px以下）でエラー吹き出しが画面内に収まる
✅ 文字サイズが小さくなり、改行される

### 変更ファイル一覧

#### 修正
- `techgear-store/src/pages/Contact/Contact.tsx` - すべてのセキュリティ機能を実装
- `techgear-store/src/pages/Contact/Contact.css` - エラー吹き出しスタイルとレスポンシブ対応

### テスト結果
✅ レート制限動作確認
✅ リアルタイムバリデーション動作確認
✅ スパムフィルター動作確認
✅ Honeypot動作確認
✅ レスポンシブ対応確認
✅ エラー吹き出しデザイン確認

---

## 最終成果物（更新）

### 完成した機能
1. ✅ **EmailJS統合** - お問い合わせフォームが実際にメール送信可能
2. ✅ **reCAPTCHA v2 Invisible統合** - チェックボックス非表示のスパム対策
3. ✅ **独立したContactページ** - `/contact`でアクセス可能
4. ✅ **Aboutページの最適化** - 会社情報に特化
5. ✅ **ナビゲーション整備** - Header/Footerに「お問い合わせ」リンク追加
6. ✅ **レート制限** - 1時間に3回まで送信可能
7. ✅ **リアルタイムバリデーション** - フィールドごとのエラー表示（onBlur）
8. ✅ **スパムフィルター** - 禁止キーワード検出
9. ✅ **Honeypot** - ボット検知機能

### セキュリティ対策（完全版）
✅ reCAPTCHA v2 Invisible（バックグラウンド動作）
✅ レート制限（LocalStorage、1時間に3回）
✅ フォームバリデーション強化（メール、電話、文字数）
✅ スパムフィルター（禁止キーワード検出）
✅ Honeypot（ボット検知用隠しフィールド）
✅ リアルタイムバリデーション（onBlur）
✅ 環境変数による機密情報管理（.env）
✅ .envファイルのGit除外

### UX改善
✅ エラーメッセージの吹き出し表示（ブラウザデフォルト風）
✅ 残り送信可能回数の表示
✅ レスポンシブ対応（モバイルで吹き出しが画面内に収まる）
✅ フォーカスが離れた時点でのエラーフィードバック

---

## 今後の改善案（更新）

### セキュリティ強化（追加分）
- [ ] バックエンドでのreCAPTCHAトークン検証
- [ ] IPアドレスベースのレート制限
- [ ] メール送信数の監視・アラート機能

### UX改善（追加分）
- [ ] フォーム入力の自動保存（LocalStorage）
- [ ] 送信完了後の確認ページ
- [ ] 多言語対応（英語・日本語切り替え）

### 機能追加
- [ ] お問い合わせ履歴の管理画面
- [ ] 自動返信メール機能
- [ ] 添付ファイル対応

---

## 作業時間（更新）

- **EmailJS統合:** 約30分
- **reCAPTCHA v3試行錯誤:** 約1時間（失敗）
- **reCAPTCHA v2チェックボックス実装:** 約20分
- **reCAPTCHA v2 Invisible移行:** 約15分
- **Contactページ分離:** 約20分
- **セキュリティ強化実装:** 約45分
- **合計:** 約3時間10分

---

## 最終確認事項（更新）

### 動作確認済み
✅ `/contact`ページ正常表示
✅ reCAPTCHA invisible動作
✅ メール送信成功（kiyoshi315jp@gmail.comに受信確認）
✅ レート制限動作（3回制限、LocalStorageリセット）
✅ リアルタイムバリデーション動作（onBlur）
✅ スパムフィルター動作
✅ Honeypot動作
✅ レスポンシブ対応（モバイルで吹き出し正常表示）
✅ Aboutページのリンク動作
✅ Header/Footerナビゲーション動作

### 残タスク
なし - すべて完了

---

## 6. UX改善機能の実装

### ユーザーからの要望
**「送信完了後の確認ページ」と「フォーム入力の自動保存」を実装してほしい**

### 実装内容

#### 1. 送信完了ページ（ContactSuccess）

**概要:**
メール送信成功後に専用の完了ページに遷移し、ユーザーに明確なフィードバックを提供

**新規作成ファイル:**
- `techgear-store/src/pages/ContactSuccess/ContactSuccess.tsx`
- `techgear-store/src/pages/ContactSuccess/ContactSuccess.css`
- `techgear-store/src/pages/ContactSuccess/index.ts`

**デザイン特徴:**
- グラデーション背景
- 緑色のチェックマークアイコン（#4CAF50）
- 青い情報ボックス
- 黄色の注意ボックス
- スケールインアニメーション

**ルーティング:**
```tsx
// App.tsx
<Route path="/contact/success" element={<ContactSuccess />} />
```

**送信成功時の遷移:**
```tsx
// Contact.tsx
navigate('/contact/success');
```

#### 2. フォーム入力の自動保存（LocalStorage）

**概要:**
ユーザーがフォーム入力中、ブラウザをリロードしても入力内容が保持される

**実装機能:**
- 入力後500ms後に自動保存（デバウンス）
- ページ読み込み時に自動復元
- 送信成功時に自動削除
- 全フィールド対応

**実装コード:**
```tsx
const DRAFT_STORAGE_KEY = 'contact_form_draft';
const AUTOSAVE_DELAY = 500;

const [formValues, setFormValues] = useState<FormDraft>({
  name: '', company: '', email: '', phone: '', address: '',
  category: '', contactMethod: '', subject: '', message: '', savedAt: ''
});

// 自動保存
const handleInputChange = (e) => {
  setFormValues(prev => ({ ...prev, [name]: value }));
  
  if (autosaveTimerRef.current) clearTimeout(autosaveTimerRef.current);
  autosaveTimerRef.current = setTimeout(() => saveDraft(), AUTOSAVE_DELAY);
};

// 自動復元
useEffect(() => {
  const draft = loadDraft();
  if (draft && draft.savedAt) {
    setFormValues(draft);
  }
}, []);
```

### 変更ファイル一覧

#### 新規作成
- `techgear-store/src/pages/ContactSuccess/ContactSuccess.tsx`
- `techgear-store/src/pages/ContactSuccess/ContactSuccess.css`
- `techgear-store/src/pages/ContactSuccess/index.ts`

#### 修正
- `techgear-store/src/App.tsx` - ルート追加
- `techgear-store/src/pages/Contact/Contact.tsx` - 自動保存機能と遷移処理

### テスト結果

✅ 送信完了ページ遷移
✅ フォーム入力の自動保存（500msデバウンス）
✅ ブラウザリロード後の自動復元
✅ 送信成功後の下書き自動削除

### メリット

**送信完了ページ:**
- ユーザーに明確なフィードバック
- 送信成功を視覚的に確認
- 次のアクション案内

**フォーム入力の自動保存:**
- 入力途中でページを閉じても安心
- ブラウザクラッシュからの保護
- UX大幅改善

---

## 本日の最終成果物

### 完成した機能（全11項目）
1. ✅ EmailJS統合
2. ✅ reCAPTCHA v2 Invisible統合
3. ✅ 独立したContactページ
4. ✅ Aboutページの最適化
5. ✅ ナビゲーション整備
6. ✅ レート制限（1時間に3回）
7. ✅ リアルタイムバリデーション（onBlur）
8. ✅ スパムフィルター
9. ✅ Honeypot
10. ✅ 送信完了ページ
11. ✅ フォーム入力の自動保存

### 作業時間（最終）
**合計: 約4時間20分**

### 全機能動作確認済み
✅ すべての機能が正常に動作

